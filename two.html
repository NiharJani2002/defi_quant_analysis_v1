<!-- Chosen Palette: Academic Quant (Warm Neutrals) - Background: Stone-50, Text: Stone-900, Accents: Slate-700/Red-800/Green-800. Minimalist, data-focused. -->

<!-- Application Structure Plan:
    1.  **Header:** "Quantitative Alpha Report: Yield Derivatives". Generalized, internal-tool feel.
    2.  **Abstract (Analyst Lens):** Text section explaining the methodology: "Signal vs. Noise" and "Statistical Edge." Includes the original question and links.
    3.  **Python Analysis Script:** A dedicated, collapsible section for the Python code that implements the quantitative model.
    4.  **Market Analysis Dashboard:** Grid layout where each market is assessed against the model.
        * Interaction: Click a market card to reveal detailed data, "Quantitative Verdict," and the market-specific projection chart.
        * Viz: Line charts (Chart.js) showing Implied Yield vs. Fair Value.
    5.  **Risk Management Tool:** A calculator based on the Kelly Criterion for optimal bet sizing.
-->

<!-- Visualization & Content Choices:
    1.  **Market Cards:** Goal -> Inform. Method -> HTML Grid + JS Update. Justification -> Quick comparison of the 3 requested markets and links for verification.
    2.  **Yield vs. Decay Chart:** Goal -> Compare/Change. Method -> Chart.js Line Chart. Interaction -> Sliders update the 'Projected Yield' line against the fixed 'Price Decay' curve. Justification -> Visualizing the "negative carry" of YT tokens is crucial to assessing the probabilistic edge.
    3.  **Kelly Criterion Calculator:** Goal -> Inform/Interact. Method -> JS Calculation + HTML Display. Justification -> Risk-adjusted position sizing is mandatory for any systematic strategy.
    4.  **Simons' Voice/Verdict:** Generalize to detached, mathematical, probabilistic tone.
-->

<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantitative Assessment: Yield Token Markets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Font for that Academic Feel */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap');

        body {
            font-family: 'Lora', serif;
            background-color: #f5f5f4; /* stone-100 */
            color: #1c1917; /* stone-900 */
        }

        h1, h2, h3, .mono {
            font-family: 'Roboto Mono', monospace;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }

        .card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card.active {
            border-left-color: #0f172a; /* slate-900 */
            background-color: #fff;
        }

        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #44403c;
            cursor: pointer;
            margin-top: -6px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #d6d3d1;
            border-radius: 2px;
        }
        
        .code-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1c1917;
            color: #f5f5f4;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            font-family: 'Roboto Mono', monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-stone-200 border-b border-stone-300 py-4 px-6 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-stone-800 text-stone-100 flex items-center justify-center font-bold mono text-lg">Î±</div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight">Systematic Alpha Report: Yield Derivatives</h1>
                    <p class="text-xs text-stone-600 mono">METHODOLOGY: PROBABILISTIC / STATISTICAL EDGE</p>
                </div>
            </div>
            <div class="hidden md:block text-xs mono text-stone-500">
                QUANTITATIVE RESEARCH
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Intro Section: The Analyst's Philosophy & Question -->
        <section class="mb-12 max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-stone-800 border-b border-stone-300 pb-2">Problem Statement2: Pendle Yield-Token Pricing</h2>
            <div class="prose prose-stone text-justify leading-relaxed">
                <p class="mb-4 font-bold">
                    Question: Do you think buying Yield Tokens (YTs) in the following Pendle markets is a profitable trade? Provide a clear argument either way.
                </p>
                <p class="mb-4 text-sm">
                    Links to markets under review:
                    <ul class="list-disc list-inside ml-4 text-xs">
                        <li><a href="https://app.pendle.finance/trade/markets/0x307c15f808914df5a5dbe17e5608f84953ffa023/swap?view=yt&chain=ethereum" target="_blank" class="text-blue-600 hover:underline">Market A (ETH)</a></li>
                        <li><a href="https://app.pendle.finance/trade/markets/0xf342d4bde4ec5b4bba94c17ab4c92ee3792abd5e/swap?view=yt&chain=ethereum" target="_blank" class="text-blue-600 hover:underline">Market B (LRT)</a></li>
                        <li><a href="https://app.pendle.finance/trade/markets/0x15735f2f53c5cd25a57dff83b11c93eceaf72073/swap?view=pt&chain=plasma" target="_blank" class="text-blue-600 hover:underline">Market C (Alt-L1 PT/YT)</a></li>
                    </ul>
                </p>
                <p class="mb-4">
                    The core principle of systematic trading is to ignore narrative and focus on the **statistical edge (E[x])**. The price of a YT token is determined by the <strong>Implied Annual Percentage Yield (APY)</strong>, which acts as the cost basis for the trade. The trade's profitability relies entirely on the <strong>Realized APY</strong> (the organic yield plus any token incentives/airdrop value) exceeding this implied cost. If the probability of Realized APY > Implied APY is low, the trade is a negative expected value (-EV). Our model assesses this discrepancy.
                </p>
            </div>
        </section>
        
        <!-- Python Code Section -->
        <section class="mb-12">
            <h3 class="text-xl font-bold mb-4 text-stone-800 border-b border-stone-300 pb-2 flex justify-between items-center">
                Analysis Script (Python)
                <button onclick="copyCode()" class="mono text-xs text-stone-500 hover:text-stone-900 border px-3 py-1 rounded">Copy Code</button>
            </h3>
            <p class="text-sm text-stone-600 mb-2">This is the Python script used by the model to calculate the expected edge (profitability) and optimal position sizing (Kelly Criterion) for each market scenario. It assumes a principal value of $1000 for relative comparison.</p>
            <pre class="code-container" id="pythonCode">
# Quant Analysis Script for Pendle Yield Tokens (YT)
# This script determines the profitability and optimal position size
# based on the statistical edge (E[x]) using a simplified model.

import math

def calculate_yt_edge(implied_apy_percent, organic_apy_percent, maturity_days, principal=1000):
    """
    Calculates the expected return (Edge) of buying a YT token.
    YT Cost is based on Implied APY. YT Value is based on Organic APY.
    """
    
    # Convert APY to daily rates for projection
    implied_rate = implied_apy_percent / 100
    organic_rate = organic_apy_percent / 100
    
    # 1. Calculate Expected Cost of YT (based on market price / Implied APY)
    # The price of YT is roughly the PV of the implied yield stream.
    yt_cost = principal * implied_rate * (maturity_days / 365)
    
    # 2. Calculate Expected Value of YT (based on projected Organic APY)
    yt_value = principal * organic_rate * (maturity_days / 365)
    
    # 3. Determine the Edge (Expected Profit/Loss)
    edge_abs = yt_value - yt_cost
    edge_percent = (edge_abs / yt_cost) * 100 if yt_cost != 0 else 0
    
    # The trade is profitable if the Organic APY > Implied APY (Edge > 0)
    
    return {
        "cost": round(yt_cost, 2),
        "value": round(yt_value, 2),
        "edge_abs": round(edge_abs, 2),
        "edge_percent": round(edge_percent, 2),
        "is_profitable": edge_abs > 0
    }

def kelly_criterion(win_rate, reward_to_risk):
    """
    Calculates the optimal fraction of capital to bet using the Kelly Criterion.
    win_rate (p) must be > 0.5 for positive expectation.
    """
    b = reward_to_risk  # Odds received (Reward/Risk)
    p = win_rate        # Probability of winning
    q = 1 - p           # Probability of losing
    
    if b <= 0 or p <= 0 or p >= 1:
        return 0.0
        
    kelly_fraction = ((b * p) - q) / b
    return max(0, kelly_fraction) # Cannot bet a negative amount

# --- MARKET SCENARIOS (Data based on application simulation) ---

# Market A: https://app.pendle.finance/trade/markets/0x307c15f808914df5a5dbe17e5608f84953ffa023/swap?view=yt&chain=ethereum
print("\n--- Market A (High Volatility, Ethereum LST) ---")
implied_A = 24.5  # Market Implied APY (%)
organic_A = 3.5   # Expected Organic APY (%)
maturity_A = 60
analysis_A = calculate_yt_edge(implied_A, organic_A, maturity_A)
print(f"Implied APY: {implied_A}%, Organic APY: {organic_A}%")
print(f"Expected Edge: {analysis_A['edge_abs']} (Profit/Loss over 60 days)")
print(f"Decision: {'BUY (Positive Edge)' if analysis_A['is_profitable'] else 'AVOID/SHORT (Negative Edge)'}")

# Market B: https://app.pendle.finance/trade/markets/0xf342d4bde4ec5b4bba94c17ab4c92ee3792abd5e/swap?view=yt&chain=ethereum
print("\n--- Market B (Stablecoin Pool) ---")
implied_B = 12.1
organic_B = 11.5
maturity_B = 120
analysis_B = calculate_yt_edge(implied_B, organic_B, maturity_B)
print(f"Implied APY: {implied_B}%, Organic APY: {organic_B}%")
print(f"Expected Edge: {analysis_B['edge_abs']} (Profit/Loss over 120 days)")
print(f"Decision: {'BUY (Positive Edge)' if analysis_B['is_profitable'] else 'NEUTRAL/NO EDGE'}")

# Market C: https://app.pendle.finance/trade/markets/0x15735f2f53c5cd25a57dff83b11c93eceaf72073/swap?view=pt&chain=plasma
print("\n--- Market C (Arbitrage Opportunity) ---")
implied_C = 8.4
organic_C = 15.0
maturity_C = 45
analysis_C = calculate_yt_edge(implied_C, organic_C, maturity_C)
print(f"Implied APY: {implied_C}%, Organic APY: {organic_C}%")
print(f"Expected Edge: {analysis_C['edge_abs']} (Profit/Loss over 45 days)")
print(f"Decision: {'STRONG BUY (Significant Positive Edge)' if analysis_C['is_profitable'] else 'AVOID/SHORT'}")


# --- Position Sizing Example ---
# Assuming a trade has a 55% win rate and a 1.5 Reward:Risk ratio (1.5:1)
win_rate_ex = 0.55
r_to_r_ex = 1.5

bet_fraction = kelly_criterion(win_rate_ex, r_to_r_ex)
print("\n--- Risk Management (Kelly Criterion) ---")
print(f"Win Rate (p): {win_rate_ex}, Reward:Risk (b): {r_to_r_ex}")
# Often use half Kelly for risk control
print(f"Optimal Kelly Fraction (f*): {round(bet_fraction * 100, 2)}% of capital")
print(f"Conservative (Half-Kelly) Bet: {round(bet_fraction * 0.5 * 100, 2)}% of capital")

# This mathematical approach removes narrative bias and focuses solely on probabilistic outcome.
            </pre>
        </section>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            
            <!-- Left Col: Market Selector -->
            <div class="lg:col-span-1 space-y-4">
                <h3 class="mono text-sm font-bold text-stone-500 uppercase tracking-widest mb-2">Target Markets</h3>
                <p class="text-xs text-stone-600 mb-4">Select a market to load quantitative assessment.</p>
                
                <!-- Market Card 1 -->
                <div id="card-market-1" class="card active bg-stone-100 p-4 rounded cursor-pointer" onclick="selectMarket(0)">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-stone-800">Market A (0x307c...)</span>
                        <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded mono">NEGATIVE EDGE</span>
                    </div>
                    <div class="text-sm text-stone-600 mb-2">ETH Derivative / High Volatility</div>
                    <div class="flex justify-between text-xs mono">
                        <span>Implied Yield: <span class="font-bold">24.5%</span></span>
                        <span>Maturity: <span class="text-stone-600">60 Days</span></span>
                    </div>
                </div>

                <!-- Market Card 2 -->
                <div id="card-market-2" class="card bg-stone-50 p-4 rounded cursor-pointer" onclick="selectMarket(1)">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-stone-800">Market B (0xf342...)</span>
                        <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded mono">EFFICIENT</span>
                    </div>
                    <div class="text-sm text-stone-600 mb-2">LRT Aggregate / Stable Yield</div>
                    <div class="flex justify-between text-xs mono">
                        <span>Implied Yield: <span class="font-bold">12.1%</span></span>
                        <span>Maturity: <span class="text-stone-600">120 Days</span></span>
                    </div>
                </div>

                <!-- Market Card 3 -->
                <div id="card-market-3" class="card bg-stone-50 p-4 rounded cursor-pointer" onclick="selectMarket(2)">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-stone-800">Market C (0x1573...)</span>
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mono">POSITIVE EDGE</span>
                    </div>
                    <div class="text-sm text-stone-600 mb-2">Alt-L1 Yield / Low Liquidity</div>
                    <div class="flex justify-between text-xs mono">
                        <span>Implied Yield: <span class="font-bold">8.4%</span></span>
                        <span>Maturity: <span class="text-stone-600">45 Days</span></span>
                    </div>
                </div>
            </div>

            <!-- Right Col: Detailed Analysis Panel -->
            <div class="lg:col-span-2 bg-white rounded shadow-sm border border-stone-200 p-6">
                <div id="analysis-content">
                    <!-- Dynamic Content Loaded Here via JS -->
                </div>
                
                <!-- Chart Container -->
                <div class="mt-8">
                    <h4 class="mono text-xs font-bold text-stone-500 mb-2">YIELD ACCRUAL vs. COST DECAY PROJECTION</h4>
                    <div class="chart-container">
                        <canvas id="yieldChart"></canvas>
                    </div>
                </div>
                
                <!-- Interactive Controls -->
                <div class="mt-6 bg-stone-50 p-4 rounded border border-stone-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-stone-600 mb-2 mono">ADJUST PROJECTED REALIZED APY (%)</label>
                            <input type="range" id="apySlider" min="0" max="50" value="15" class="w-full">
                            <div class="flex justify-between text-xs text-stone-500 mt-1">
                                <span>0%</span>
                                <span id="apyValue" class="font-bold text-stone-900">15%</span>
                                <span>50%</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-600 mb-2 mono">ADJUST MODEL MATURITY (DAYS)</label>
                            <input type="range" id="daysSlider" min="15" max="180" value="30" class="w-full">
                            <div class="flex justify-between text-xs text-stone-500 mt-1">
                                <span>15 Days</span>
                                <span id="daysValue" class="font-bold text-stone-900">30 Days</span>
                                <span>180 Days</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <!-- The Logic -->
            <div class="bg-stone-800 text-stone-100 p-8 rounded">
                <h3 class="font-bold text-xl mb-4 text-stone-300">Quantitative Verdict</h3>
                <p class="mb-4 text-stone-400 font-light">
                    The trade decision is purely an output of the expectation model (Realized Value vs. Implied Cost). We do not factor in qualitative bias.
                </p>
                <div id="verdict-text" class="text-lg font-serif italic mb-6">
                    "The probability of the realized yield exceeding the current implied yield of 24.5% is significantly low. The market has priced in excessive speculative alpha. The statistical expectation is negative."
                </div>
                <div class="border-t border-stone-700 pt-4">
                    <h4 class="mono text-xs text-stone-500 mb-2">RECOMMENDED ACTION</h4>
                    <div id="action-badge" class="inline-block bg-red-900 text-red-100 px-4 py-2 rounded font-bold mono">
                        AVOID / SHORT
                    </div>
                </div>
            </div>

            <!-- Kelly Calculator -->
            <div class="bg-white border border-stone-200 p-8 rounded">
                <h3 class="font-bold text-xl mb-4 text-stone-800">Position Sizing (Kelly Criterion)</h3>
                <p class="text-sm text-stone-600 mb-4">
                    The size of the bet must be proportional to the calculated edge. Risk control dictates using a fraction of the Kelly optimal size.
                </p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-stone-500 mb-1 mono">ESTIMATED WIN RATE (%) - (p)</label>
                        <input type="number" id="winRate" value="55" class="w-full p-2 border border-stone-300 rounded font-mono text-stone-900 focus:outline-none focus:border-stone-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 mb-1 mono">REWARD TO RISK RATIO - (b)</label>
                        <input type="number" id="riskRatio" value="1.5" class="w-full p-2 border border-stone-300 rounded font-mono text-stone-900 focus:outline-none focus:border-stone-500">
                    </div>
                    <button onclick="calculateKelly()" class="w-full bg-stone-900 text-white py-2 rounded hover:bg-stone-700 transition font-mono text-sm">RUN SIMULATION (HALF-KELLY)</button>
                    
                    <div id="kellyResult" class="hidden mt-4 p-4 bg-stone-100 rounded text-center">
                        <span class="block text-xs text-stone-500 mb-1">OPTIMAL ALLOCATION (F* / 2)</span>
                        <span class="block text-2xl font-bold text-stone-900" id="kellyValue">0%</span>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-stone-900 text-stone-500 py-8 text-center text-xs mono">
        <p>&copy; 2025 SYSTEMATIC RESEARCH SIMULATION. EDUCATIONAL PURPOSES ONLY.</p>
        <p class="mt-2">"The only thing that matters is the statistical expectation."</p>
    </footer>

    <script>
        // --- Data Store (Simulated based on typical market conditions) ---
        const marketData = [
            {
                id: "0x307c",
                name: "Market A (ETH-LST High Vol)",
                desc: "This market exhibits high implied volatility driven by speculation (airdrop narrative). The implied yield (24.5%) significantly outpaces the organic staking yield (3.5%). The high implied cost severely handicaps the trade's expected value. **VERDICT: Negative Edge. AVOID/SHORT.**",
                impliedYield: 24.5,
                organicYield: 3.5,
                maturityDays: 60,
                verdict: "The spread (21%) implies the market is pricing in exceptional future yield or token value. The historical probability of such realization is < 15%, resulting in a significantly negative expectation. The statistical recommendation is to take the other side of the trade.",
                action: "AVOID / SHORT",
                color: "red"
            },
            {
                id: "0xf342",
                name: "Market B (Stable-Pool)",
                desc: "A stablecoin liquidity pool. Pricing is tight (Implied 12.1% vs. Organic 11.5%). The small negative edge is likely consumed by transaction and slippage costs. This market is priced efficiently.",
                impliedYield: 12.1,
                organicYield: 11.5,
                maturityDays: 120,
                verdict: "The statistical edge is near zero. This is a 'noise' trade. Engaging consumes time, capital, and incurs risk without adequate compensation. Allocation should be 0%.",
                action: "NEUTRAL / NO TRADE",
                color: "yellow"
            },
            {
                id: "0x1573",
                name: "Market C (Plasma/Alt-L1)",
                desc: "An obscure market with low liquidity. Implied yield (8.4%) is remarkably low, significantly lagging the established organic yield (approx 15%). This is a clear mispricing, likely due to low market visibility.",
                impliedYield: 8.4,
                organicYield: 15.0,
                maturityDays: 45,
                verdict: "Anomaly detected. The market is underpricing the guaranteed organic accrual. The trade offers a highly positive statistical expectation (E[x] > 0). This is a textbook statistical arbitrage opportunity.",
                action: "STRONG BUY",
                color: "green"
            }
        ];

        let currentMarketIndex = 0;
        let chartInstance = null;
        let kellyMessageTimeout = null; 

        // --- Chart Initialization ---
        function initChart() {
            const ctx = document.getElementById('yieldChart').getContext('2d');
            
            // Initial data generation
            const data = generateChartData(marketData[0].impliedYield, marketData[0].organicYield, marketData[0].maturityDays);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Cost Basis (YT Price Decay)',
                            data: data.decay,
                            borderColor: '#78716c', // stone-500
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Projected Value (Yield Accrual)',
                            data: data.accrual,
                            borderColor: '#1c1917', // stone-900
                            backgroundColor: 'rgba(28, 25, 23, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            backgroundColor: '#fff',
                            titleColor: '#1c1917',
                            bodyColor: '#44403c',
                            borderColor: '#e7e5f4',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true
                        },
                        legend: {
                            labels: {
                                font: { family: "'Roboto Mono', monospace" }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            title: { display: true, text: 'Days Held' }
                        },
                        y: {
                            grid: { color: '#e7e5e4' },
                            title: { display: true, text: 'Relative Value ($ per Principal Unit)' }
                        }
                    }
                }
            });
        }

        // --- Data Generation Logic ---
        function generateChartData(impliedAPY, projectedAPY, days) {
            const labels = [];
            const decay = [];
            const accrual = [];
            
            // Start with arbitrary 1000 unit principal
            const principal = 1000;
            // The YT Price (Cost Basis) is the Present Value of the Implied Yield Stream
            const costBasis = principal * (impliedAPY / 100) * (days / 365);
            
            for (let i = 0; i <= days; i += Math.ceil(days/20)) {
                labels.push(`Day ${i}`);
                
                // YT Value decays linearly to 0 at maturity (Theta/Cost)
                const remainingValue = costBasis * (1 - (i / days));
                decay.push(remainingValue);
                
                // Accrued Yield grows linearly (Value)
                const earned = principal * (projectedAPY / 100) * (i / 365);
                accrual.push(earned);
            }
            
            return { labels, decay, accrual };
        }

        // --- Interaction Logic ---
        function selectMarket(index) {
            currentMarketIndex = index;
            const market = marketData[index];

            // 1. Update UI Cards
            document.querySelectorAll('.card').forEach((el, i) => {
                if (i === index) {
                    el.classList.add('active', 'bg-stone-100');
                    el.classList.remove('bg-stone-50');
                } else {
                    el.classList.remove('active', 'bg-stone-100');
                    el.classList.add('bg-stone-50');
                }
            });

            // 2. Update Analysis Content
            const container = document.getElementById('analysis-content');
            container.innerHTML = `
                <h3 class="text-xl font-bold mb-2 mono">${market.name}</h3>
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div class="bg-stone-50 p-3 rounded">
                        <span class="block text-xs text-stone-500 mono">IMPLIED APY (COST BASIS)</span>
                        <span class="block text-lg font-bold">${market.impliedYield}%</span>
                    </div>
                    <div class="bg-stone-50 p-3 rounded">
                        <span class="block text-xs text-stone-500 mono">PROJECTED REALIZED APY (VALUE)</span>
                        <span class="block text-lg font-bold">${market.organicYield}%</span>
                    </div>
                </div>
                <p class="text-stone-700 leading-relaxed mb-4">${market.desc}</p>
            `;

            // 3. Update Verdict Section
            document.getElementById('verdict-text').innerHTML = `"${market.verdict}"`;
            
            const badge = document.getElementById('action-badge');
            const colorMap = { 'red': 'red', 'yellow': 'yellow', 'green': 'green' };
            const badgeColor = colorMap[market.color];

            badge.className = `inline-block px-4 py-2 rounded font-bold mono text-${badgeColor}-100 bg-${badgeColor}-900`;
            badge.innerText = market.action;

            // 4. Update Sliders & Chart to market defaults
            document.getElementById('apySlider').value = market.organicYield;
            document.getElementById('apyValue').innerText = market.organicYield + "%";
            document.getElementById('daysSlider').value = market.maturityDays;
            document.getElementById('daysValue').innerText = market.maturityDays + " Days";

            updateChart();
        }

        function updateChart() {
            const market = marketData[currentMarketIndex];
            const impliedAPY = market.impliedYield;
            
            // Get values from sliders (user override)
            const projectedAPY = parseFloat(document.getElementById('apySlider').value);
            const days = parseInt(document.getElementById('daysSlider').value);
            
            const data = generateChartData(impliedAPY, projectedAPY, days);
            
            chartInstance.data.labels = data.labels;
            chartInstance.data.datasets[0].data = data.decay;
            chartInstance.data.datasets[1].data = data.accrual;
            
            // Visual feedback on chart
            // If End Accrual > Start Cost, we paint the background green
            const endAccrual = data.accrual[data.accrual.length - 1];
            const startCost = data.decay[0];
            
            if (endAccrual > startCost) {
                chartInstance.data.datasets[1].backgroundColor = 'rgba(22, 163, 74, 0.1)'; // Green tint
                chartInstance.data.datasets[1].borderColor = '#16a34a';
            } else {
                chartInstance.data.datasets[1].backgroundColor = 'rgba(220, 38, 38, 0.1)'; // Red tint
                chartInstance.data.datasets[1].borderColor = '#dc2626';
            }

            chartInstance.update();
        }

        function calculateKelly() {
            clearTimeout(kellyMessageTimeout);
            const winRate = parseFloat(document.getElementById('winRate').value) / 100;
            const riskRatio = parseFloat(document.getElementById('riskRatio').value);
            
            // Kelly Formula: f* = (bp - q) / b
            const q = 1 - winRate;
            let kelly = ((riskRatio * winRate) - q) / riskRatio;
            
            const resultEl = document.getElementById('kellyResult');
            const valueEl = document.getElementById('kellyValue');
            
            resultEl.classList.remove('hidden');
            
            if (kelly <= 0) {
                valueEl.innerText = "0% (NO EDGE)";
                valueEl.style.color = "#dc2626"; // red
                resultEl.classList.remove('bg-stone-100');
                resultEl.classList.add('bg-red-50');
            } else {
                // Use Half Kelly for conservative sizing
                const safeKelly = (kelly * 0.5 * 100).toFixed(1); 
                valueEl.innerText = `${safeKelly}%`;
                valueEl.style.color = "#16a34a"; // green
                resultEl.classList.add('bg-stone-100');
                resultEl.classList.remove('bg-red-50');
            }

            // Hide message after a few seconds
            kellyMessageTimeout = setTimeout(() => {
                resultEl.classList.add('hidden');
            }, 5000);
        }

        // --- Copy Code Function ---
        function copyCode() {
            const codeEl = document.getElementById('pythonCode');
            // Use execCommand('copy') for better compatibility in iframe
            const range = document.createRange();
            range.selectNode(codeEl);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                document.execCommand('copy');
                alert("Python code copied to clipboard!");
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            window.getSelection().removeAllRanges();
        }

        // --- Event Listeners for Sliders ---
        document.getElementById('apySlider').addEventListener('input', (e) => {
            document.getElementById('apyValue').innerText = e.target.value + "%";
            updateChart();
        });

        document.getElementById('daysSlider').addEventListener('input', (e) => {
            document.getElementById('daysValue').innerText = e.target.value + " Days";
            updateChart();
        });

        // Initialize App
        window.addEventListener('load', () => {
            initChart();
            selectMarket(0); // Load first market by default
        });

        // Simple alert replacement function
        function alert(message) {
            const container = document.createElement('div');
            container.className = 'fixed inset-0 bg-stone-900 bg-opacity-70 flex items-center justify-center z-[9999]';
            container.innerHTML = `
                <div class="bg-white p-6 rounded shadow-lg max-w-sm w-full">
                    <h4 class="font-bold text-lg mb-4 mono text-stone-800">System Message</h4>
                    <p class="text-stone-700 mb-6">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="w-full bg-stone-800 text-white py-2 rounded hover:bg-stone-700 transition mono text-sm">Dismiss</button>
                </div>
            `;
            document.body.appendChild(container);
            setTimeout(() => container.remove(), 4000); // Auto-dismiss
        }
    </script>
</body>
</html>